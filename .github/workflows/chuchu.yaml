name: Pipeline do chuchu
on:
  pull_request:
    branches:
      - development
    paths-ignore:
      - README.md

jobs:
  chuchu:
    name: "My very first job"
    runs-on: ubuntu-latest
    steps:
      - name: Running test01
        run: echo "Opa, blz ? Parece que boa hein ?!"
      - name: Getting the code
        uses: actions/checkout@v2
      - name: Setup ruby
        uses: ruby/setup-ruby@v1
      - name: Install rubocop
        run: gem install bundler rubocop-rails rubocop
      - name: Run Rubocop
        run: rubocop

  # ---------------------------------------- #
  # Building application  
  # ---------------------------------------- #
                      
buid_n_package:
    name:  Build and Package
    runs-on: ubuntu-20.04
    env:
      ghub_sha: ${{ github.sha }}
      pr_owner: ${{ github.event.pull_request.head.repo.owner.login }}
    steps:
      # checked on 2021-04-08
      # https://github.com/actions/checkout
      - uses: actions/checkout@v2
      - run: | 
          curl -L https://storage.solvis.net.br/public/pipeline/${{ env.app_name }}/rabbitmq.yml > config/rabbitmq.yml
          curl -L https://storage.solvis.net.br/public/pipeline/${{ env.app_name }}/master.key > config/master.key
      # The action short-sha was deprecated.
      # https://github.com/benjlevesque/short-sha
      # deprecated
      - name: short-sha
        id: short-sha
        run: |
          echo "::set-output name=sha::$(echo "${{ env.ghub_sha }}" | cut -c1-8)"
      # checked on 2021-04-08
      # https://github.com/elgohr/Publish-Docker-Github-Action
      - name: Build and send image to registry
        uses: elgohr/Publish-Docker-Github-Action@master
        id: build
        with:
          registry: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          name: solvis-engineering/${{ env.app_name }}/${{ env.app_name }}
          tags: ${{ steps.short-sha.outputs.sha }}
          dockerfile: Dockerfile
          buildargs: |
            BUILD_RAILS_ENV=production
            BUNDLE_WITHOUT=development/test
            GHUB_USER=solvis-eng
            GHUB_PASS=${{ env.ghub_pkg_token }}

  
  
